<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–§–æ—Ç–æ-–≥–∞–ª–µ—Ä–µ—è | –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #0f172a, #1e293b);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 24px;
            font-weight: bold;
        }

        .btn {
            background: #6366f1;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .btn:hover {
            background: #4f46e5;
        }

        .btn.secondary {
            background: transparent;
            border: 1px solid #64748b;
        }

        .main-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #64748b;
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: #6366f1;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .image-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .image-item:hover {
            transform: translateY(-5px);
        }

        .thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .image-actions {
            padding: 15px;
            display: flex;
            gap: 10px;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .action-btn:hover {
            background: #6366f1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
        }

        .edit-modal {
            background: #1e293b;
            border-radius: 12px;
            padding: 30px;
            max-width: 95%;
            margin: 0 auto;
        }

        .edit-preview {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .preview-container {
            flex: 1;
            text-align: center;
            min-width: 300px;
        }

        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            background: #0f172a;
        }

        .edit-controls {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 15px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        input[type="range"] {
            width: 100%;
        }

        .filter-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .filter-btn {
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .filter-btn.active {
            background: #6366f1;
        }

        .edit-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stickers-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .sticker-item {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 24px;
        }

        .sticker-item:hover {
            background: #6366f1;
        }

        .upload-form {
            max-width: 500px;
            margin: 0 auto;
            text-align: center;
        }

        .file-upload {
            border: 2px dashed #64748b;
            border-radius: 12px;
            padding: 40px;
            margin: 20px 0;
            cursor: pointer;
        }

        .file-upload:hover {
            border-color: #6366f1;
        }

        .message {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .canvas-container {
            position: relative;
            display: inline-block;
        }

        .drawing-canvas {
            position: absolute;
            top: 0;
            left: 0;
            cursor: crosshair;
        }

        .shape-options {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            flex-wrap: wrap;
        }

        .shape-btn {
            padding: 8px 15px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
        }

        .shape-btn.active {
            background: #6366f1;
        }

        .crop-area {
            position: absolute;
            border: 2px dashed #6366f1;
            background: rgba(99, 102, 241, 0.2);
            cursor: move;
        }

        .crop-handle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #6366f1;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-camera"></i>
                <span>–§–æ—Ç–æ-–≥–∞–ª–µ—Ä–µ—è</span>
            </div>
            <div>
                <span id="imageCounter">0 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π</span>
                <button class="btn" id="uploadTabBtn" style="margin-left: 15px;">
                    <i class="fas fa-cloud-upload-alt"></i>
                    –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ
                </button>
            </div>
        </header>
        
        <div class="main-content">
            <div class="tabs">
                <div class="tab active" data-tab="gallery">–ì–∞–ª–µ—Ä–µ—è</div>
                <div class="tab" data-tab="upload">–ó–∞–≥—Ä—É–∑–∏—Ç—å</div>
            </div>
            
            <div class="tab-content active" id="gallery">
                <div id="galleryContent">
                    <!-- –ì–∞–ª–µ—Ä–µ—è –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
                </div>
            </div>
            
            <div class="tab-content" id="upload">
                <div class="upload-form">
                    <h2>–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</h2>
                    <form id="uploadForm">
                        <div class="file-upload" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–∞</p>
                            <p style="font-size: 12px; color: #64748b; margin-top: 10px;">
                                JPG, PNG, GIF, WebP ‚Ä¢ –ú–∞–∫—Å. 5MB
                            </p>
                        </div>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <div>
                            <img id="imagePreview" style="max-width: 100%; max-height: 200px; display: none; border-radius: 8px;">
                        </div>
                        <div style="margin: 20px 0;">
                            <textarea id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è..." style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid #64748b; color: white;" rows="3"></textarea>
                        </div>
                        <button type="submit" class="btn">
                            <i class="fas fa-upload"></i>
                            –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                        </button>
                    </form>
                    <div id="uploadMessage"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editModal" class="modal">
        <div class="edit-modal">
            <h2 style="margin-bottom: 20px; text-align: center;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h2>
            
            <div class="edit-preview">
                <div class="preview-container">
                    <h4>–û—Ä–∏–≥–∏–Ω–∞–ª</h4>
                    <img id="originalPreview" class="preview-image">
                </div>
                <div class="preview-container">
                    <h4>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è</h4>
                    <div class="canvas-container">
                        <canvas id="editPreview" class="preview-image"></canvas>
                        <canvas id="drawingCanvas" class="drawing-canvas"></canvas>
                        <div id="cropOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none;"></div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button class="btn secondary edit-tab-btn active" data-tab="adjust">–ö–æ—Ä—Ä–µ–∫—Ü–∏—è</button>
                <button class="btn secondary edit-tab-btn" data-tab="filters">–§–∏–ª—å—Ç—Ä—ã</button>
                <button class="btn secondary edit-tab-btn" data-tab="crop">–û–±—Ä–µ–∑–∫–∞</button>
                <button class="btn secondary edit-tab-btn" data-tab="text">–¢–µ–∫—Å—Ç</button>
                <button class="btn secondary edit-tab-btn" data-tab="watermark">–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫</button>
                <button class="btn secondary edit-tab-btn" data-tab="draw">–†–∏—Å–æ–≤–∞–Ω–∏–µ</button>
                <button class="btn secondary edit-tab-btn" data-tab="stickers">–°—Ç–∏–∫–µ—Ä—ã</button>
            </div>

            <!-- –ö–æ—Ä—Ä–µ–∫—Ü–∏—è -->
            <div class="edit-controls" id="adjust-controls">
                <div class="control-group">
                    <div class="control-label">
                        <span>–Ø—Ä–∫–æ—Å—Ç—å</span>
                        <span id="brightnessValue">100%</span>
                    </div>
                    <input type="range" id="brightness" min="0" max="200" value="100">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>–ö–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–æ—Å—Ç—å</span>
                        <span id="contrastValue">100%</span>
                    </div>
                    <input type="range" id="contrast" min="0" max="200" value="100">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>–ù–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å</span>
                        <span id="saturationValue">100%</span>
                    </div>
                    <input type="range" id="saturation" min="0" max="200" value="100">
                </div>
            </div>

            <!-- –§–∏–ª—å—Ç—Ä—ã -->
            <div class="edit-controls" id="filters-controls" style="display: none;">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="none">–ù–µ—Ç</button>
                    <button class="filter-btn" data-filter="grayscale">–ß/–ë</button>
                    <button class="filter-btn" data-filter="sepia">–°–µ–ø–∏—è</button>
                    <button class="filter-btn" data-filter="invert">–ò–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="filter-btn" data-filter="vintage">–í–∏–Ω—Ç–∞–∂</button>
                    <button class="filter-btn" data-filter="cool">–•–æ–ª–æ–¥–Ω—ã–π</button>
                    <button class="filter-btn" data-filter="warm">–¢–µ–ø–ª—ã–π</button>
                </div>
            </div>

            <!-- –û–±—Ä–µ–∑–∫–∞ -->
            <div class="edit-controls" id="crop-controls" style="display: none;">
                <div style="margin-bottom: 15px;">
                    <button class="btn" id="startCropBtn">–ù–∞—á–∞—Ç—å –æ–±—Ä–µ–∑–∫—É</button>
                    <button class="btn secondary" id="applyCropBtn" style="display: none;">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –æ–±—Ä–µ–∑–∫—É</button>
                    <button class="btn secondary" id="cancelCropBtn" style="display: none;">–û—Ç–º–µ–Ω–∞</button>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω</span>
                    </div>
                    <select id="cropRatio" style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid #64748b; color: white;">
                        <option value="free">–°–≤–æ–±–æ–¥–Ω–æ–µ</option>
                        <option value="1:1">1:1 (–ö–≤–∞–¥—Ä–∞—Ç)</option>
                        <option value="4:3">4:3</option>
                        <option value="16:9">16:9</option>
                        <option value="3:2">3:2</option>
                    </select>
                </div>
            </div>

            <!-- –¢–µ–∫—Å—Ç -->
            <div class="edit-controls" id="text-controls" style="display: none;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="textInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..." style="flex: 1; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid #64748b; color: white;">
                    <button class="btn" id="addTextBtn">–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</span>
                        <span id="textSizeValue">24px</span>
                    </div>
                    <input type="range" id="textSize" min="12" max="72" value="24">
                </div>
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="color" id="textColor" value="#ffffff" style="width: 50px; height: 40px;">
                    <select id="textFont" style="flex: 1; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid #64748b; color: white;">
                        <option value="Arial">Arial</option>
                        <option value="Times New Roman">Times New Roman</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Verdana">Verdana</option>
                    </select>
                </div>
                <button class="btn secondary" id="removeTextBtn">–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—Å—Ç</button>
            </div>

            <!-- –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ -->
            <div class="edit-controls" id="watermark-controls" style="display: none;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                    <input type="text" id="watermarkText" value="–ú–æ—è –≥–∞–ª–µ—Ä–µ—è" style="flex: 1; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid #64748b; color: white;">
                    <button class="btn" id="applyWatermarkBtn">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>–ü—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å</span>
                        <span id="watermarkOpacityValue">50%</span>
                    </div>
                    <input type="range" id="watermarkOpacity" min="10" max="100" value="50">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>–†–∞–∑–º–µ—Ä</span>
                        <span id="watermarkSizeValue">24px</span>
                    </div>
                    <input type="range" id="watermarkSize" min="12" max="48" value="24">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span>–ü–æ–∑–∏—Ü–∏—è</span>
                    </div>
                    <select id="watermarkPosition" style="width: 100%; padding: 8px; border-radius: 6px; background: rgba(255,255,255,0.1); border: 1px solid #64748b; color: white;">
                        <option value="top-left">–í–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π</option>
                        <option value="top-right">–í–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π</option>
                        <option value="bottom-left">–ù–∏–∂–Ω–∏–π –ª–µ–≤—ã–π</option>
                        <option value="bottom-right">–ù–∏–∂–Ω–∏–π –ø—Ä–∞–≤—ã–π</option>
                        <option value="center">–¶–µ–Ω—Ç—Ä</option>
                    </select>
                </div>
                <button class="btn secondary" id="removeWatermarkBtn">–£–¥–∞–ª–∏—Ç—å –≤–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫</button>
            </div>

            <!-- –†–∏—Å–æ–≤–∞–Ω–∏–µ -->
            <div class="edit-controls" id="draw-controls" style="display: none;">
                <div style="display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap;">
                    <button class="btn secondary draw-tool-btn active" data-tool="brush">–ö–∏—Å—Ç—å</button>
                    <button class="btn secondary draw-tool-btn" data-tool="eraser">–õ–∞—Å—Ç–∏–∫</button>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>–¶–≤–µ—Ç:</span>
                        <input type="color" id="drawColor" value="#ff0000" style="width: 40px; height: 30px;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span>–†–∞–∑–º–µ—Ä:</span>
                        <input type="range" id="brushSize" min="1" max="50" value="5" style="width: 100px;">
                        <span id="brushSizeValue">5px</span>
                    </div>
                </div>
                <div class="shape-options">
                    <button class="shape-btn" data-shape="rectangle">–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫</button>
                    <button class="shape-btn" data-shape="circle">–ö—Ä—É–≥</button>
                    <button class="shape-btn" data-shape="line">–õ–∏–Ω–∏—è</button>
                    <button class="shape-btn" data-shape="triangle">–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫</button>
                    <button class="shape-btn" data-shape="arrow">–°—Ç—Ä–µ–ª–∫–∞</button>
                </div>
                <button class="btn secondary" id="clearDrawingBtn">–û—á–∏—Å—Ç–∏—Ç—å —Ä–∏—Å—É–Ω–æ–∫</button>
            </div>

            <!-- –°—Ç–∏–∫–µ—Ä—ã -->
            <div class="edit-controls" id="stickers-controls" style="display: none;">
                <div class="stickers-container" id="stickersContainer">
                    <!-- –°—Ç–∏–∫–µ—Ä—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn secondary" id="removeStickerBtn">–£–¥–∞–ª–∏—Ç—å —Å—Ç–∏–∫–µ—Ä</button>
                    <button class="btn secondary" id="clearStickersBtn">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
                </div>
            </div>

            <div class="edit-actions">
                <button class="btn" id="saveEditBtn">
                    <i class="fas fa-save"></i>
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn secondary" id="cancelEditBtn">
                    <i class="fas fa-times"></i>
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button class="btn secondary" id="resetEditBtn">
                    <i class="fas fa-undo"></i>
                    –°–±—Ä–æ—Å–∏—Ç—å
                </button>
            </div>
        </div>
    </div>

    <script>
        // –î–∞–Ω–Ω—ã–µ –≥–∞–ª–µ—Ä–µ–∏
        let galleryData = JSON.parse(localStorage.getItem('galleryData')) || [];
        let currentEditingImage = null;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã canvas
        let editCanvas, editCtx, drawingCanvas, drawingCtx, originalImage;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        let editSettings = {
            brightness: 100,
            contrast: 100,
            saturation: 100,
            filter: 'none',
            drawColor: '#ff0000',
            brushSize: 5,
            textSettings: {
                size: 24,
                color: '#ffffff',
                font: 'Arial'
            },
            watermark: {
                text: '–ú–æ—è –≥–∞–ª–µ—Ä–µ—è',
                opacity: 50,
                size: 24,
                position: 'bottom-right',
                enabled: false
            }
        };

        // –°–æ—Å—Ç–æ—è–Ω–∏–µ
        let stickers = [];
        let textElements = [];
        let isDrawing = false;
        let lastX = 0, lastY = 0;
        let currentTool = 'brush';
        let currentShape = null;
        let shapeStartX = 0, shapeStartY = 0;
        let selectedSticker = null;
        let isCropping = false;
        let cropArea = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
        });

        function initApp() {
            initTabs();
            loadGallery();
            initUploadForm();
            initEditModal();
            updateImageCounter();
        }

        function initTabs() {
            // –û—Å–Ω–æ–≤–Ω—ã–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab).classList.add('active');
                });
            });

            document.getElementById('uploadTabBtn').addEventListener('click', function() {
                switchToTab('upload');
            });

            // –í–∫–ª–∞–¥–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            document.querySelectorAll('.edit-tab-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.edit-tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.edit-controls').forEach(c => c.style.display = 'none');
                    
                    this.classList.add('active');
                    document.getElementById(this.dataset.tab + '-controls').style.display = 'block';
                    
                    // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
                    if (this.dataset.tab === 'crop') {
                        initCropMode();
                    } else {
                        exitCropMode();
                    }
                });
            });
        }

        function switchToTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function loadGallery() {
            const galleryContent = document.getElementById('galleryContent');
            
            if (galleryData.length === 0) {
                galleryContent.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px;">
                        <div style="font-size: 48px; color: #64748b; margin-bottom: 20px;">
                            <i class="fas fa-images"></i>
                        </div>
                        <h3 style="margin-bottom: 10px;">–ì–∞–ª–µ—Ä–µ—è –ø—É—Å—Ç–∞</h3>
                        <p style="color: #64748b; margin-bottom: 20px;">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</p>
                        <button class="btn" onclick="switchToTab('upload')">
                            <i class="fas fa-plus"></i>
                            –î–æ–±–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ
                        </button>
                    </div>
                `;
                return;
            }

            let html = '<div class="images-grid">';
            galleryData.forEach(image => {
                const thumb = image.edited ? image.edited.thumbnail : image.thumbnail;
                const badge = image.edited ? '<div style="position: absolute; top: 10px; left: 10px; background: #f59e0b; color: white; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: bold;">–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ</div>' : '';
                html += `
                    <div class="image-item" style="position: relative;">
                        <img src="${thumb}" alt="${image.description}" class="thumbnail">
                        ${badge}
                        <div class="image-actions">
                            <div class="action-btn edit" onclick="editImage('${image.id}')">
                                <i class="fas fa-edit"></i>
                            </div>
                            <div class="action-btn delete" onclick="deleteImage('${image.id}')">
                                <i class="fas fa-trash"></i>
                            </div>
                        </div>
                        <div style="padding: 15px;">
                            <div style="margin-bottom: 5px;">${image.description}</div>
                            <div style="font-size: 12px; color: #64748b;">
                                ${new Date(image.uploadTime).toLocaleDateString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            galleryContent.innerHTML = html;
        }

        function initUploadForm() {
            const imageInput = document.getElementById('imageInput');
            const imagePreview = document.getElementById('imagePreview');

            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        imagePreview.src = e.target.result;
                        imagePreview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('uploadForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const file = imageInput.files[0];
                const description = document.getElementById('description').value || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è';

                if (!file) {
                    showMessage('–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'error');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = 300;
                        canvas.height = (img.height / img.width) * 300;
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        const thumbnail = canvas.toDataURL('image/jpeg');

                        const imageData = {
                            id: Date.now().toString(),
                            original: e.target.result,
                            thumbnail: thumbnail,
                            description: description,
                            uploadTime: Date.now()
                        };

                        galleryData.unshift(imageData);
                        localStorage.setItem('galleryData', JSON.stringify(galleryData));
                        
                        showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!', 'success');
                        imageInput.value = '';
                        imagePreview.style.display = 'none';
                        document.getElementById('description').value = '';
                        
                        setTimeout(() => {
                            loadGallery();
                            updateImageCounter();
                            switchToTab('gallery');
                        }, 1000);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        function initEditModal() {
            // –ö–æ—Ä—Ä–µ–∫—Ü–∏—è
            document.getElementById('brightness').addEventListener('input', function() {
                editSettings.brightness = this.value;
                document.getElementById('brightnessValue').textContent = this.value + '%';
                applyAllEdits();
            });

            document.getElementById('contrast').addEventListener('input', function() {
                editSettings.contrast = this.value;
                document.getElementById('contrastValue').textContent = this.value + '%';
                applyAllEdits();
            });

            document.getElementById('saturation').addEventListener('input', function() {
                editSettings.saturation = this.value;
                document.getElementById('saturationValue').textContent = this.value + '%';
                applyAllEdits();
            });

            // –§–∏–ª—å—Ç—Ä—ã
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    editSettings.filter = this.dataset.filter;
                    applyAllEdits();
                });
            });

            // –û–±—Ä–µ–∑–∫–∞
            document.getElementById('startCropBtn').addEventListener('click', startCrop);
            document.getElementById('applyCropBtn').addEventListener('click', applyCrop);
            document.getElementById('cancelCropBtn').addEventListener('click', cancelCrop);

            // –¢–µ–∫—Å—Ç
            document.getElementById('addTextBtn').addEventListener('click', function() {
                const text = document.getElementById('textInput').value.trim();
                if (text) {
                    textElements.push({ 
                        text: text, 
                        x: 50, 
                        y: 50,
                        size: editSettings.textSettings.size,
                        color: editSettings.textSettings.color,
                        font: editSettings.textSettings.font
                    });
                    applyAllEdits();
                    document.getElementById('textInput').value = '';
                    showMessage('–¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω. –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –µ–≥–æ –º—ã—à—å—é', 'success');
                }
            });

            document.getElementById('textSize').addEventListener('input', function() {
                editSettings.textSettings.size = this.value;
                document.getElementById('textSizeValue').textContent = this.value + 'px';
                if (textElements.length > 0) {
                    textElements[textElements.length - 1].size = this.value;
                    applyAllEdits();
                }
            });

            document.getElementById('textColor').addEventListener('input', function() {
                editSettings.textSettings.color = this.value;
                if (textElements.length > 0) {
                    textElements[textElements.length - 1].color = this.value;
                    applyAllEdits();
                }
            });

            document.getElementById('textFont').addEventListener('change', function() {
                editSettings.textSettings.font = this.value;
                if (textElements.length > 0) {
                    textElements[textElements.length - 1].font = this.value;
                    applyAllEdits();
                }
            });

            document.getElementById('removeTextBtn').addEventListener('click', function() {
                if (textElements.length > 0) {
                    textElements.pop();
                    applyAllEdits();
                    showMessage('–¢–µ–∫—Å—Ç —É–¥–∞–ª–µ–Ω', 'success');
                }
            });

            // –í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫
            document.getElementById('applyWatermarkBtn').addEventListener('click', function() {
                const text = document.getElementById('watermarkText').value.trim();
                if (text) {
                    editSettings.watermark.text = text;
                    editSettings.watermark.enabled = true;
                    applyAllEdits();
                    showMessage('–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ –ø—Ä–∏–º–µ–Ω–µ–Ω', 'success');
                }
            });

            document.getElementById('watermarkOpacity').addEventListener('input', function() {
                editSettings.watermark.opacity = this.value;
                document.getElementById('watermarkOpacityValue').textContent = this.value + '%';
                applyAllEdits();
            });

            document.getElementById('watermarkSize').addEventListener('input', function() {
                editSettings.watermark.size = this.value;
                document.getElementById('watermarkSizeValue').textContent = this.value + 'px';
                applyAllEdits();
            });

            document.getElementById('watermarkPosition').addEventListener('change', function() {
                editSettings.watermark.position = this.value;
                applyAllEdits();
            });

            document.getElementById('removeWatermarkBtn').addEventListener('click', function() {
                editSettings.watermark.enabled = false;
                applyAllEdits();
                showMessage('–í–æ–¥—è–Ω–æ–π –∑–Ω–∞–∫ —É–¥–∞–ª–µ–Ω', 'success');
            });

            // –†–∏—Å–æ–≤–∞–Ω–∏–µ
            initDrawingTools();

            // –°—Ç–∏–∫–µ—Ä—ã
            initStickerTools();

            // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            document.getElementById('saveEditBtn').addEventListener('click', saveEditedImage);
            document.getElementById('cancelEditBtn').addEventListener('click', closeEditModal);
            document.getElementById('resetEditBtn').addEventListener('click', resetEditSettings);
        }

        function initDrawingTools() {
            // –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã
            document.querySelectorAll('.draw-tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.draw-tool-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentTool = this.dataset.tool;
                    currentShape = null;
                });
            });

            // –§–∏–≥—É—Ä—ã
            document.querySelectorAll('.shape-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    currentShape = this.dataset.shape;
                    currentTool = 'shape';
                    showMessage(`–í—ã–±—Ä–∞–Ω–∞ —Ñ–∏–≥—É—Ä–∞: ${this.textContent}`, 'success');
                });
            });

            document.getElementById('drawColor').addEventListener('input', function() {
                editSettings.drawColor = this.value;
            });

            document.getElementById('brushSize').addEventListener('input', function() {
                editSettings.brushSize = this.value;
                document.getElementById('brushSizeValue').textContent = this.value + 'px';
            });

            document.getElementById('clearDrawingBtn').addEventListener('click', function() {
                drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                showMessage('–†–∏—Å—É–Ω–æ–∫ –æ—á–∏—â–µ–Ω', 'success');
            });

            // –°–æ–±—ã—Ç–∏—è —Ä–∏—Å–æ–≤–∞–Ω–∏—è
            drawingCanvas.addEventListener('mousedown', startDrawing);
            drawingCanvas.addEventListener('mousemove', draw);
            drawingCanvas.addEventListener('mouseup', stopDrawing);
            drawingCanvas.addEventListener('mouseout', stopDrawing);
        }

        function startDrawing(e) {
            if (isCropping) return;
            
            isDrawing = true;
            const rect = drawingCanvas.getBoundingClientRect();
            [lastX, lastY] = [e.clientX - rect.left, e.clientY - rect.top];
            shapeStartX = lastX;
            shapeStartY = lastY;

            if (currentTool === 'brush' || currentTool === 'eraser') {
                drawingCtx.beginPath();
                drawingCtx.moveTo(lastX, lastY);
            }
        }

        function draw(e) {
            if (!isDrawing || isCropping) return;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;

            if (currentTool === 'brush' || currentTool === 'eraser') {
                drawingCtx.lineTo(x, y);
                
                if (currentTool === 'brush') {
                    drawingCtx.strokeStyle = editSettings.drawColor;
                    drawingCtx.lineWidth = editSettings.brushSize;
                } else {
                    drawingCtx.strokeStyle = '#000000';
                    drawingCtx.globalCompositeOperation = 'destination-out';
                }
                
                drawingCtx.lineCap = 'round';
                drawingCtx.lineJoin = 'round';
                drawingCtx.stroke();
                
                [lastX, lastY] = [x, y];
            }
        }

        function stopDrawing() {
            if (!isDrawing || isCropping) return;
            
            const rect = drawingCanvas.getBoundingClientRect();
            const x = lastX;
            const y = lastY;

            if (currentTool === 'shape' && currentShape) {
                drawShape(shapeStartX, shapeStartY, x, y);
            }

            isDrawing = false;
            drawingCtx.globalCompositeOperation = 'source-over';
        }

        function drawShape(startX, startY, endX, endY) {
            drawingCtx.beginPath();
            drawingCtx.strokeStyle = editSettings.drawColor;
            drawingCtx.lineWidth = editSettings.brushSize;

            switch (currentShape) {
                case 'rectangle':
                    drawingCtx.rect(startX, startY, endX - startX, endY - startY);
                    break;
                case 'circle':
                    const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                    drawingCtx.arc(startX, startY, radius, 0, 2 * Math.PI);
                    break;
                case 'line':
                    drawingCtx.moveTo(startX, startY);
                    drawingCtx.lineTo(endX, endY);
                    break;
                case 'triangle':
                    drawingCtx.moveTo(startX, startY);
                    drawingCtx.lineTo(endX, endY);
                    drawingCtx.lineTo(startX * 2 - endX, endY);
                    drawingCtx.closePath();
                    break;
                case 'arrow':
                    drawArrow(startX, startY, endX, endY);
                    break;
            }

            drawingCtx.stroke();
        }

        function drawArrow(fromX, fromY, toX, toY) {
            const headlen = 15;
            const angle = Math.atan2(toY - fromY, toX - fromX);
            
            drawingCtx.moveTo(fromX, fromY);
            drawingCtx.lineTo(toX, toY);
            drawingCtx.lineTo(toX - headlen * Math.cos(angle - Math.PI/6), toY - headlen * Math.sin(angle - Math.PI/6));
            drawingCtx.moveTo(toX, toY);
            drawingCtx.lineTo(toX - headlen * Math.cos(angle + Math.PI/6), toY - headlen * Math.sin(angle + Math.PI/6));
        }

        function initStickerTools() {
            const stickers = ['üòÄ', 'üòç', 'üòÇ', 'ü•∞', 'üòé', '‚ù§Ô∏è', '‚ú®', 'üåü', 'üéâ', 'üî•', 'üëç', 'üéà', '‚≠ê', 'üíØ'];
            const container = document.getElementById('stickersContainer');
            
            stickers.forEach(sticker => {
                const div = document.createElement('div');
                div.className = 'sticker-item';
                div.textContent = sticker;
                div.addEventListener('click', () => {
                    selectedSticker = sticker;
                    showMessage('–ö–ª–∏–∫–Ω–∏—Ç–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç–∏–∫–µ—Ä', 'success');
                });
                container.appendChild(div);
            });

            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–∏–∫–µ—Ä–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            editCanvas.addEventListener('click', function(e) {
                if (!selectedSticker || isCropping) return;
                
                const rect = editCanvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                
                stickers.push({ emoji: selectedSticker, x: x, y: y });
                applyAllEdits();
                showMessage('–°—Ç–∏–∫–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            });

            document.getElementById('removeStickerBtn').addEventListener('click', function() {
                if (stickers.length > 0) {
                    stickers.pop();
                    applyAllEdits();
                    showMessage('–°—Ç–∏–∫–µ—Ä —É–¥–∞–ª–µ–Ω', 'success');
                }
            });

            document.getElementById('clearStickersBtn').addEventListener('click', function() {
                if (stickers.length > 0) {
                    stickers.length = 0;
                    applyAllEdits();
                    showMessage('–í—Å–µ —Å—Ç–∏–∫–µ—Ä—ã —É–¥–∞–ª–µ–Ω—ã', 'success');
                }
            });
        }

        function initCropMode() {
            isCropping = true;
            document.getElementById('startCropBtn').style.display = 'none';
            document.getElementById('applyCropBtn').style.display = 'inline-block';
            document.getElementById('cancelCropBtn').style.display = 'inline-block';
            document.getElementById('cropOverlay').style.display = 'block';
            
            createCropArea();
        }

        function exitCropMode() {
            isCropping = false;
            document.getElementById('startCropBtn').style.display = 'inline-block';
            document.getElementById('applyCropBtn').style.display = 'none';
            document.getElementById('cancelCropBtn').style.display = 'none';
            document.getElementById('cropOverlay').style.display = 'none';
            
            if (cropArea) {
                cropArea.remove();
                cropArea = null;
            }
        }

        function createCropArea() {
            const overlay = document.getElementById('cropOverlay');
            cropArea = document.createElement('div');
            cropArea.className = 'crop-area';
            cropArea.style.width = '200px';
            cropArea.style.height = '200px';
            cropArea.style.left = '50%';
            cropArea.style.top = '50%';
            cropArea.style.transform = 'translate(-50%, -50%)';
            
            overlay.appendChild(cropArea);
            makeElementDraggable(cropArea);
            addResizeHandles(cropArea);
        }

        function makeElementDraggable(element) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            
            element.onmousedown = dragMouseDown;
            
            function dragMouseDown(e) {
                e.preventDefault();
                pos3 = e.clientX;
                pos4 = e.clientY;
                document.onmouseup = closeDragElement;
                document.onmousemove = elementDrag;
            }
            
            function elementDrag(e) {
                e.preventDefault();
                pos1 = pos3 - e.clientX;
                pos2 = pos4 - e.clientY;
                pos3 = e.clientX;
                pos4 = e.clientY;
                
                element.style.top = (element.offsetTop - pos2) + "px";
                element.style.left = (element.offsetLeft - pos1) + "px";
            }
            
            function closeDragElement() {
                document.onmouseup = null;
                document.onmousemove = null;
            }
        }

        function addResizeHandles(element) {
            const handles = ['nw', 'ne', 'sw', 'se'];
            handles.forEach(handle => {
                const div = document.createElement('div');
                div.className = `crop-handle ${handle}`;
                element.appendChild(div);
                
                div.addEventListener('mousedown', function(e) {
                    e.stopPropagation();
                    startResize(element, handle);
                });
            });
        }

        function startResize(element, handle) {
            const startX = event.clientX;
            const startY = event.clientY;
            const startWidth = parseInt(document.defaultView.getComputedStyle(element).width, 10);
            const startHeight = parseInt(document.defaultView.getComputedStyle(element).height, 10);
            const startLeft = parseInt(document.defaultView.getComputedStyle(element).left, 10);
            const startTop = parseInt(document.defaultView.getComputedStyle(element).top, 10);

            function resize(e) {
                if (handle.includes('e')) {
                    element.style.width = (startWidth + e.clientX - startX) + 'px';
                }
                if (handle.includes('w')) {
                    element.style.width = (startWidth - e.clientX + startX) + 'px';
                    element.style.left = (startLeft + e.clientX - startX) + 'px';
                }
                if (handle.includes('s')) {
                    element.style.height = (startHeight + e.clientY - startY) + 'px';
                }
                if (handle.includes('n')) {
                    element.style.height = (startHeight - e.clientY + startY) + 'px';
                    element.style.top = (startTop + e.clientY - startY) + 'px';
                }
            }

            function stopResize() {
                document.removeEventListener('mousemove', resize);
                document.removeEventListener('mouseup', stopResize);
            }

            document.addEventListener('mousemove', resize);
            document.addEventListener('mouseup', stopResize);
        }

        function startCrop() {
            initCropMode();
        }

        function applyCrop() {
            if (!cropArea) return;
            
            const rect = cropArea.getBoundingClientRect();
            const canvasRect = editCanvas.getBoundingClientRect();
            
            const x = rect.left - canvasRect.left;
            const y = rect.top - canvasRect.top;
            const width = rect.width;
            const height = rect.height;
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π canvas —Å –æ–±—Ä–µ–∑–∞–Ω–Ω—ã–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = width;
            tempCanvas.height = height;
            
            tempCtx.drawImage(editCanvas, x, y, width, height, 0, 0, width, height);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π canvas
            editCanvas.width = width;
            editCanvas.height = height;
            drawingCanvas.width = width;
            drawingCanvas.height = height;
            
            editCtx.drawImage(tempCanvas, 0, 0);
            
            exitCropMode();
            showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±—Ä–µ–∑–∞–Ω–æ', 'success');
        }

        function cancelCrop() {
            exitCropMode();
            showMessage('–û–±—Ä–µ–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞', 'success');
        }

        function editImage(id) {
            const image = galleryData.find(img => img.id === id);
            if (!image) return;

            currentEditingImage = image;
            document.getElementById('originalPreview').src = image.original;

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è canvas
            editCanvas = document.getElementById('editPreview');
            editCtx = editCanvas.getContext('2d');
            drawingCanvas = document.getElementById('drawingCanvas');
            drawingCtx = drawingCanvas.getContext('2d');

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            originalImage = new Image();
            originalImage.onload = function() {
                editCanvas.width = originalImage.width;
                editCanvas.height = originalImage.height;
                drawingCanvas.width = originalImage.width;
                drawingCanvas.height = originalImage.height;

                applyOriginalImage();
                
                // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
                if (image.edited) {
                    if (image.edited.settings) {
                        editSettings = { ...image.edited.settings };
                        restoreEditSettings();
                    }
                    if (image.edited.stickers) stickers = [...image.edited.stickers];
                    if (image.edited.textElements) textElements = [...image.edited.textElements];
                    if (image.edited.drawing) {
                        const img = new Image();
                        img.onload = () => drawingCtx.drawImage(img, 0, 0);
                        img.src = image.edited.drawing;
                    }
                }

                applyAllEdits();
            };
            originalImage.src = image.original;

            document.getElementById('editModal').style.display = 'block';
        }

        function applyOriginalImage() {
            editCtx.clearRect(0, 0, editCanvas.width, editCanvas.height);
            editCtx.drawImage(originalImage, 0, 0);
        }

        function applyFilters() {
            let filter = '';
            if (editSettings.brightness !== 100) filter += `brightness(${editSettings.brightness}%) `;
            if (editSettings.contrast !== 100) filter += `contrast(${editSettings.contrast}%) `;
            if (editSettings.saturation !== 100) filter += `saturate(${editSettings.saturation}%) `;
            
            switch (editSettings.filter) {
                case 'grayscale': filter += 'grayscale(1)'; break;
                case 'sepia': filter += 'sepia(1)'; break;
                case 'invert': filter += 'invert(1)'; break;
                case 'vintage': filter += 'sepia(0.5) hue-rotate(-20deg) contrast(1.1)'; break;
                case 'cool': filter += 'hue-rotate(180deg) contrast(1.1)'; break;
                case 'warm': filter += 'sepia(0.3) hue-rotate(10deg)'; break;
            }
            
            editCtx.filter = filter;
            editCtx.drawImage(originalImage, 0, 0);
            editCtx.filter = 'none';
        }

        function applyText() {
            textElements.forEach(textObj => {
                editCtx.font = `${textObj.size}px ${textObj.font}`;
                editCtx.fillStyle = textObj.color;
                editCtx.fillText(textObj.text, textObj.x, textObj.y);
            });
        }

        function applyStickers() {
            stickers.forEach(sticker => {
                editCtx.font = '40px Arial';
                editCtx.fillText(sticker.emoji, sticker.x, sticker.y);
            });
        }

        function applyWatermark() {
            if (!editSettings.watermark.enabled) return;
            
            editCtx.font = `${editSettings.watermark.size}px Arial`;
            editCtx.fillStyle = `rgba(255, 255, 255, ${editSettings.watermark.opacity / 100})`;
            editCtx.globalAlpha = editSettings.watermark.opacity / 100;
            
            let x, y;
            const padding = 20;
            
            switch (editSettings.watermark.position) {
                case 'top-left':
                    x = padding;
                    y = padding + editSettings.watermark.size;
                    break;
                case 'top-right':
                    x = editCanvas.width - editCtx.measureText(editSettings.watermark.text).width - padding;
                    y = padding + editSettings.watermark.size;
                    break;
                case 'bottom-left':
                    x = padding;
                    y = editCanvas.height - padding;
                    break;
                case 'bottom-right':
                    x = editCanvas.width - editCtx.measureText(editSettings.watermark.text).width - padding;
                    y = editCanvas.height - padding;
                    break;
                case 'center':
                    x = (editCanvas.width - editCtx.measureText(editSettings.watermark.text).width) / 2;
                    y = editCanvas.height / 2;
                    break;
            }
            
            editCtx.fillText(editSettings.watermark.text, x, y);
            editCtx.globalAlpha = 1;
        }

        function applyAllEdits() {
            applyOriginalImage();
            applyFilters();
            applyText();
            applyStickers();
            applyWatermark();
        }

        function restoreEditSettings() {
            document.getElementById('brightness').value = editSettings.brightness;
            document.getElementById('contrast').value = editSettings.contrast;
            document.getElementById('saturation').value = editSettings.saturation;
            document.getElementById('drawColor').value = editSettings.drawColor;
            document.getElementById('brushSize').value = editSettings.brushSize;
            document.getElementById('textSize').value = editSettings.textSettings.size;
            document.getElementById('textColor').value = editSettings.textSettings.color;
            document.getElementById('textFont').value = editSettings.textSettings.font;
            document.getElementById('watermarkText').value = editSettings.watermark.text;
            document.getElementById('watermarkOpacity').value = editSettings.watermark.opacity;
            document.getElementById('watermarkSize').value = editSettings.watermark.size;
            document.getElementById('watermarkPosition').value = editSettings.watermark.position;
            
            document.getElementById('brightnessValue').textContent = editSettings.brightness + '%';
            document.getElementById('contrastValue').textContent = editSettings.contrast + '%';
            document.getElementById('saturationValue').textContent = editSettings.saturation + '%';
            document.getElementById('brushSizeValue').textContent = editSettings.brushSize + 'px';
            document.getElementById('textSizeValue').textContent = editSettings.textSettings.size + 'px';
            document.getElementById('watermarkOpacityValue').textContent = editSettings.watermark.opacity + '%';
            document.getElementById('watermarkSizeValue').textContent = editSettings.watermark.size + 'px';
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === editSettings.filter);
            });
        }

        function resetEditSettings() {
            editSettings = {
                brightness: 100,
                contrast: 100,
                saturation: 100,
                filter: 'none',
                drawColor: '#ff0000',
                brushSize: 5,
                textSettings: {
                    size: 24,
                    color: '#ffffff',
                    font: 'Arial'
                },
                watermark: {
                    text: '–ú–æ—è –≥–∞–ª–µ—Ä–µ—è',
                    opacity: 50,
                    size: 24,
                    position: 'bottom-right',
                    enabled: false
                }
            };
            
            stickers = [];
            textElements = [];
            drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
            exitCropMode();
            
            restoreEditSettings();
            applyAllEdits();
            showMessage('–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã', 'success');
        }

        function saveEditedImage() {
            if (!currentEditingImage) return;

            // –°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = editCanvas.width;
            tempCanvas.height = editCanvas.height;

            // –û–±—ä–µ–¥–∏–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö —Å–ª–æ–µ–≤
            tempCtx.drawImage(editCanvas, 0, 0);
            tempCtx.drawImage(drawingCanvas, 0, 0);

            const editedDataURL = tempCanvas.toDataURL('image/jpeg', 0.9);

            // –°–æ–∑–¥–∞–Ω–∏–µ –º–∏–Ω–∏–∞—Ç—é—Ä—ã
            const thumbCanvas = document.createElement('canvas');
            const thumbCtx = thumbCanvas.getContext('2d');
            thumbCanvas.width = 300;
            thumbCanvas.height = (editCanvas.height / editCanvas.width) * 300;
            thumbCtx.drawImage(tempCanvas, 0, 0, thumbCanvas.width, thumbCanvas.height);
            const thumbDataURL = thumbCanvas.toDataURL('image/jpeg', 0.9);

            const drawingDataURL = drawingCanvas.toDataURL('image/png');

            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            currentEditingImage.edited = {
                original: editedDataURL,
                thumbnail: thumbDataURL,
                settings: { ...editSettings },
                stickers: [...stickers],
                textElements: [...textElements],
                drawing: drawingDataURL
            };

            localStorage.setItem('galleryData', JSON.stringify(galleryData));
            closeEditModal();
            loadGallery();
            showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ', 'success');
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            exitCropMode();
        }

        function deleteImage(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ?')) {
                galleryData = galleryData.filter(img => img.id !== id);
                localStorage.setItem('galleryData', JSON.stringify(galleryData));
                loadGallery();
                updateImageCounter();
                showMessage('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
            }
        }

        function updateImageCounter() {
            document.getElementById('imageCounter').textContent = 
                `${galleryData.length} –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π`;
        }

        function showMessage(message, type) {
            const div = document.getElementById('uploadMessage');
            const color = type === 'success' ? '#10b981' : '#ef4444';
            div.innerHTML = `<div class="message" style="background: rgba(${type === 'success' ? '16,185,129' : '239,68,68'}, 0.2); color: ${color};">${message}</div>`;
            setTimeout(() => div.innerHTML = '', 3000);
        }
    </script>
</body>
</html>